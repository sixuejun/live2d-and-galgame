# Galgame 界面功能说明

## 概述

这是一个完整的 Galgame 风格对话界面，用于在酒馆（SillyTavern）中提供沉浸式的视觉小说体验。界面支持 Live2D 模型渲染、多种对话框样式自定义、智能消息格式解析、世界书资源自动匹配、角色状态栏、以及与酒馆的深度集成。

界面采用 16:9 横屏显示，支持响应式缩放，可在不同设备和屏幕方向下自动适配。

---

## 项目结构

```
live2d与galgame界面前端/
├── index.html          # 入口 HTML
├── index.ts            # 入口脚本，挂载 Vue 应用
├── app.vue             # 根组件
├── Live2DRenderer.ts   # Live2D 渲染器封装
├── components/
│   ├── GalgamePlayer.vue        # 主播放器组件
│   ├── DialogBox.vue            # 对话框组件
│   ├── ChoiceBox.vue            # 选项框组件
│   ├── CharacterSprite.vue      # 角色立绘组件
│   ├── CharacterStatusPanel.vue # 角色状态栏组件
│   ├── SettingsPanel.vue        # 设置面板组件
│   ├── DialogPreview.vue        # 对话框预览组件
│   └── ColorSlider.vue          # 颜色选择器组件
├── lib/
│   ├── messageParser.ts  # 消息解析器（支持新格式和世界书匹配）
│   └── utils.ts          # 工具函数
├── types/
│   └── galgame.ts        # 类型定义和样式预设
├── utils/
│   └── indexedDB.ts      # IndexedDB 工具
└── styles/
    └── globals.css       # 全局样式（Tailwind CSS 主题）
```

---

## 核心功能

### 1. 智能消息格式解析系统

界面支持两种消息格式：**新格式（键值对格式）**和**旧格式（位置格式）**，新格式更灵活且易于维护。

#### 1.1 新格式（推荐使用）

新格式使用 `键名：值` 的键值对形式，支持多种冒号格式（全角、半角），解析更智能：

##### Character 格式

**普通对话模式：**

```
[[character||角色名：程北极||场景：家中||动作：抱胸||表情：生气||台词：你怎么这样！]]
```

**CG 模式：**

```
[[character||角色名：程北极||CG场景：家中||台词：你怎么这样！]]
```

**字段说明：**

- `角色名`：角色名称，用于匹配 Live2D 模型和立绘资源
- `场景`：场景描述文本，用于匹配背景图片（不包括台词部分）
- `动作`：动作描述文本，用于匹配 Live2D 动作文件和立绘（不包括台词部分）
- `表情`：表情描述文本，用于匹配 Live2D 表情文件（不包括台词部分）
- `台词`：角色对话内容，不参与资源匹配
- `CG场景`：CG 场景描述，触发 CG 模式时用于匹配 CG 图片

**特点：**

- 字段顺序可以调整
- 缺失的字段会自动使用默认值或继承上一行的场景
- 如果没有动作和表情，自动进入 CG 模式

##### Narration 格式

```
[[narration||场景：教室||旁白：教室里阳光明媚，同学们正在认真听讲。]]
```

**字段说明：**

- `场景`：场景描述文本，用于匹配背景图片
- `旁白`：旁白内容

##### Blacktext 格式

```
[[blacktext||黑屏文字：三小时后...]]
```

**字段说明：**

- `黑屏文字`：黑屏转场时显示的文字

##### User 格式

```
[[user||场景：教室||用户消息：我想去图书馆。]]
```

**字段说明：**

- `场景`：场景描述文本，用于匹配背景图片
- `用户消息`：用户输入的消息内容

##### Choice 格式

```
[[choice||选项1：去食堂||选项2：去图书馆||选项3：回宿舍]]
```

**字段说明：**

- `选项1`、`选项2`、`选项3`：选项文本，支持任意数量的选项

#### 1.2 旧格式（兼容支持）

为保持向后兼容，界面仍支持旧的位置格式：

```
[[character||角色名||场景||动作||表情||台词]]
[[character||角色名||CG场景||台词]]
[[narration||场景||旁白内容]]
[[blacktext||黑屏文字]]
[[user||场景||用户消息]]
[[choice||选项1||选项2||选项3]]
```

#### 1.3 解析特性

**只解析 `<content>` 标签内的内容：**

- 消息解析器只解析 `<content>...</content>` 标签中的剧情格式
- 位于 `<content>` 标签外的内容不会被解析（如 StatusBlock）
- 如果消息中没有 `<content>` 标签，则解析整个消息内容

**智能冒号识别：**

- 支持全角冒号（：）
- 支持半角冒号（:）
- 自动处理冒号前后的空格

**字段容错：**

- 支持中文键名（如：`角色名`、`场景`）
- 支持英文键名（如：`character`、`scene`）作为备用
- 键名不区分大小写（如：`CG场景`、`cg场景`、`CG`）

**场景继承：**

- 当上一行解析到场景，而下一行没有场景时，自动沿用上一行的场景
- 确保场景切换的连贯性

**特殊标记：**

- **through 消息**：在台词中包含 `*through*` 会显示为浅灰色斜体（内心独白）
- **CG 模式自动检测**：当没有动作和表情时，自动进入 CG 模式，隐藏立绘显示 CG

**未解析消息处理：**

- 如果消息中没有解析到任何格式块，该消息不会显示
- StatusBlock 位于 `<content>` 之外，只用于状态栏显示，不创建对话项

---

### 2. 世界书资源自动匹配系统

界面会在每次演出前从世界书中读取资源映射配置，并根据解析到的文本自动匹配对应的资源文件。

#### 2.1 世界书配置

资源配置存储在名为 `开场界面-模型数据` 的世界书中，使用 JSON 格式存储：

**Live2D 模型资源：**

```json
{
  "type": "live2d_model",
  "modelName": "程北极",
  "files": {
    "model3": "https://example.com/models/character.model3.json",
    "textures": ["texture_00.png", "texture_01.png"]
  },
  "motions": [
    { "name": "待机", "file": "idle.motion3.json", "group": "idle" },
    { "name": "抱胸", "file": "cross_arms.motion3.json", "group": "gesture" }
  ],
  "expressions": [
    { "name": "生气", "file": "angry.exp3.json" },
    { "name": "开心", "file": "happy.exp3.json" }
  ],
  "textMappings": {
    "motion": {
      "idle.motion3.json": "待机",
      "cross_arms.motion3.json": "抱胸"
    },
    "expression": {
      "angry.exp3.json": "生气",
      "happy.exp3.json": "开心"
    }
  }
}
```

**立绘资源：**

```json
{
  "type": "sprite",
  "characterName": "程北极",
  "sprites": [
    {
      "name": "抱胸",
      "file": "https://example.com/sprites/cross_arms.png",
      "textMappings": ["抱胸", "交叉双手"]
    }
  ]
}
```

**背景资源：**

```json
{
  "type": "background",
  "backgrounds": [
    {
      "name": "家中",
      "file": "https://example.com/backgrounds/home.jpg",
      "textMappings": ["家中", "家里", "家"]
    }
  ]
}
```

**CG 资源：**

```json
{
  "type": "cg",
  "cgs": [
    {
      "name": "家中",
      "file": "https://example.com/cgs/home_cg.jpg",
      "textMappings": ["家中", "家里"]
    }
  ]
}
```

#### 2.2 智能匹配算法

**模糊匹配：**

- 自动去除特殊符号（`-`、`/`、`\`、`_`、`.`、空格）进行匹配
- 支持部分匹配（如："开-心" 可以匹配 "开心"）
- 不区分大小写

**匹配规则：**

1. **背景图片匹配：**
   - 匹配字段：`场景`（不包括台词部分）
   - 匹配顺序：先匹配 `textMappings`，再匹配 `name`
   - 应用场景：普通对话模式、旁白、用户消息

2. **CG 图片匹配：**
   - 匹配字段：`CG场景`
   - 匹配顺序：先匹配 `textMappings`，再匹配 `name`
   - 应用场景：CG 模式对话

3. **立绘图片匹配：**
   - 匹配字段：`动作`、`表情`（不包括台词部分）
   - 角色区分：通过 `角色名` 确定角色，不同角色的相同文本会匹配到不同文件
   - 匹配顺序：先匹配 `textMappings`，再匹配 `name`

4. **Live2D 动作匹配：**
   - 匹配字段：`动作`（不包括台词部分）
   - 角色区分：通过 `角色名` 确定模型
   - 匹配顺序：先通过 `textMappings.motion` 匹配，再通过文件名匹配

5. **Live2D 表情匹配：**
   - 匹配字段：`表情`（不包括台词部分）
   - 角色区分：通过 `角色名` 确定模型
   - 匹配顺序：先通过 `textMappings.expression` 匹配，再通过文件名匹配

#### 2.3 资源缓存机制

- 世界书资源数据会缓存 5 秒，避免频繁读取
- 每次演出开始前会重新读取，确保使用最新的资源配置
- 缓存失效后自动重新加载

#### 2.4 匹配结果应用

解析器会将匹配到的资源文件路径填充到 `MessageBlock` 中：

- `sceneImageUrl`：背景图片 URL
- `cgImageUrl`：CG 图片 URL
- `spriteImageUrl`：立绘图片 URL
- `motionFile`：动作文件路径
- `expressionFile`：表情文件路径

界面会根据这些信息自动加载对应的资源。

---

### 3. 对话系统

#### 3.1 对话框功能

**打字机效果：**

- 文字逐字显示（默认 50ms/字符）
- 流式加载时对已完成文本应用打字机效果
- 可通过设置调整速度

**角色名称显示：**

- 支持多种名称标签样式（标签、胶囊、方形、下划线、悬浮）
- 可自定义颜色和样式

**旁白系统：**

- 无角色名的消息以斜体居中显示
- 支持旁白专用样式

**Through 消息：**

- 特殊浅灰色斜体文字（内心独白）
- 在台词中包含 `*through*` 标记即可触发

**导航控制：**

- 左右箭头按钮切换对话
- 点击画面继续下一句
- 支持前进/后退导航

**呼吸指示器：**

- 多种动态指示器样式（呼吸点、菱形、脉冲、箭头、无）
- 提示用户点击继续

**流式加载：**

- AI 生成时显示呼吸指示器
- 对已完成文本应用打字机效果
- 实时更新显示内容

#### 3.2 对话框样式自定义

**文本框形状：**

- 圆角、胶囊（毛玻璃效果）、直角、柔和、画框
- 可自定义圆角大小、边框粗细、阴影效果

**边框样式：**

- 边框粗细：无、细、中、粗、加粗
- 可自定义边框颜色

**背景图案：**

- 无、方格、圆点、菱形、条纹、柔光渐变
- 图案颜色随边框颜色自动调整

**角色名样式：**

- 标签、胶囊、方形、下划线、悬浮
- 可自定义背景色、文字色、边框色

**箭头按钮：**

- 圆形、方形、胶囊、极简、内嵌圆、内嵌方
- 可自定义背景色、图标色

**呼吸指示器：**

- 呼吸点、菱形、脉冲、箭头、无
- 可自定义颜色
- **只在流式加载时显示动画**，正常状态下静态显示

**颜色自定义：**

- 所有元素颜色可通过颜色选择器调整
- 支持透明度设置
- 实时预览效果

**样式持久化：**

- 样式设置自动保存到 localStorage
- 刷新页面后自动恢复

---

### 4. 选项系统

#### 4.1 选项格式

界面只支持两种选项格式：

**格式1：带角色回复（继续剧情演出）**

```
[[choice||选项1：去食堂||角色名：程北极||台词：好的，我们一起去吧！]]
```

选择该选项后会显示角色回复，然后继续下一条对话，**不触发 AI 生成**。

**格式2：纯选项列表（触发AI生成）**

```
[[choice||选项1：去食堂||选项2：去图书馆||选项3：回宿舍]]
```

选择该选项后会触发 AI 生成回复。

#### 4.2 选项框功能

**选项显示：**

- 支持动态数量的选项
- 样式与对话框保持一致
- 自动识别两种格式（带角色回复和纯选项列表）

**自由输入：**

- 支持用户自定义输入文本
- 输入框自动聚焦
- 输入后按 Enter 发送

**保存功能：**

- 📇 按钮可将输入保存到正文但不发送
- 方便用户添加非对话内容

#### 4.3 选项交互

**点击选择：**

- 点击选项按钮选择
- 选择后高亮显示

**输入确认：**

- Enter 键确认输入并发送
- ESC 键取消输入

**自动发送：**

- 格式1（带角色回复）：选择后显示角色回复，继续下一条对话，不触发 AI 生成
- 格式2（纯选项列表）：选择后触发 AI 生成回复

**智能裁剪：**

- **演出中**：发送前自动删除后续剧情文本（避免污染上下文）
- **演出完成后**：直接发送，不删除后续对话（因为已经是最后一条）

#### 4.4 选项文本裁剪

**自动识别：**

- 选择选项后，自动识别并裁剪当前消息中关于选项的文本

**只保留被选选项：**

- 只留下最终被选择的选项文本，删除其他选项文本
- 格式1：删除未选择的选项块
- 格式2：只保留被选择的选项

**不刷新界面：**

- 操作类似用户编辑消息，同样不刷新界面

#### 4.5 点击区域导航

- **黑屏转场**：点击左半屏返回上一条，点击右半屏继续下一条
- **选择框界面**：点击左半屏返回上一条，点击右半屏继续下一条

---

### 5. 输入系统

#### 5.1 输入框功能

**打开方式：**

- 点击左上角角色按钮 → 输入按钮

**回车发送：**

- 在输入框中按 Enter 键直接发送消息并触发 AI 回复

**保存功能：**

- 📇 按钮可将输入保存到正文但不发送

**智能裁剪：**

- **演出中**：发送前自动删除后续剧情文本（避免污染上下文）
- **演出完成后**：直接发送，不删除后续对话

#### 5.2 输入交互

**自动聚焦：**

- 打开输入框时自动聚焦到输入框

**ESC 关闭：**

- 按 ESC 键关闭输入框

**点击外部关闭：**

- 点击输入框外部区域关闭

**格式化输出：**

- 用户输入自动格式化为 `[[user||场景：{{scene}}||用户消息：{输入内容}]]` 格式
- 自动继承当前场景

---

### 6. 角色立绘系统

#### 6.1 立绘类型

**Live2D 模型：**

- 支持完整的 Live2D 模型渲染
- 自动加载动作和表情
- 支持模型缩放、位置调整

**静态图片：**

- 支持静态图片立绘
- 根据世界书匹配或使用默认图片

**CG 模式：**

- 检测到无动作/表情文件时自动切换
- 隐藏立绘，显示 CG 图片

**自动切换：**

- 根据角色名和资源可用性自动选择立绘类型
- 优先使用 Live2D（如果可用），否则使用静态图片

#### 6.2 立绘控制

**大小调整：**

- 范围：50%-150%
- 实时预览效果

**位置调整：**

- 水平位置：0%-100%
- 垂直位置：0%-100%
- 通过设置面板调整

**资源加载：**

- 自动从世界书匹配立绘资源
- 根据动作和表情文本匹配对应立绘

---

### 7. 场景背景系统

#### 7.1 背景显示

**自动匹配：**

- 根据场景文本自动从世界书匹配背景图片
- 支持模糊匹配，容错性强

**场景继承：**

- 如果当前消息没有场景，自动继承上一行的场景

**优先级：**

1. 从世界书匹配到的背景图片 URL（`sceneImageUrl`）
2. 场景文本（如果看起来像 URL）
3. 默认背景（透明）

**CG 模式：**

- CG 模式下，背景会被 CG 图片覆盖
- CG 图片根据 `CG场景` 文本匹配

#### 7.2 场景切换

- 场景切换时自动加载新背景
- 支持平滑过渡
- 场景文本可以包含描述或 URL

---

### 8. 角色状态栏

#### 8.1 打开方式

点击左上角 👤 角色按钮 → 状态栏面板

#### 8.2 显示内容

**角色属性：**

- 时间、地点显示
- 数值属性网格（从 MVU 变量提取）
- 文本属性卡片（关系、心情、吐槽、待办）

**小剧场：**

- 气泡对话显示
- 左右分布（主视角/其他角色）
- 自动解析 `【发言人：内容】` 格式

#### 8.3 数据来源

1. **优先**：从 MVU 变量框架获取（`Mvu.getMvuData`）
2. **其次**：解析 `<StatusBlock>` 正则格式

#### 8.4 StatusBlock 格式

```
<StatusBlock>
地点: 教室
关系: 朋友
心情: 开心
吐槽: 今天天气真好
待办: 完成作业
小剧场: 【小明：你好】【小红：你也好】
</StatusBlock>
```

**注意：** StatusBlock 一般位于 `<content>` 标签之外，只用于状态栏显示，不会创建对话项。只有 `<content>` 标签内的剧情格式才会被解析并显示为对话。

---

### 9. 用户消息编辑

#### 9.1 功能特性

**保存到正文：**

- 📇 按钮将输入保存为 `[[user||场景：||用户消息：]]` 格式
- 保存到酒馆消息正文，不发送

**编辑消息：**

- 点击 user 消息可编辑
- 编辑后实时更新显示

**删除消息：**

- 可删除 user 消息
- 删除后从界面移除

**内存暂存：**

- 编辑操作先存内存，发送时应用
- 避免频繁刷新界面

#### 9.2 编辑流程

1. 用户点击 user 消息
2. 弹出编辑框
3. 修改内容后确认
4. 更新内存中的编辑状态
5. 发送时应用到酒馆消息

---

### 10. 流式加载支持

#### 10.1 实时显示

- AI 生成时显示呼吸指示器
- 对已完成文本应用打字机效果
- 实时更新显示内容
- 流式加载时显示"正在生成..."状态

#### 10.2 状态管理

- 正确处理流式/完成状态切换
- 流式结束后自动应用完整文本
- 自动监听 `STREAM_TOKEN_RECEIVED` 事件
- 消息完成后自动清除流式状态

#### 10.3 界面稳定性

- 所有编辑操作都不刷新界面，保持界面状态
- 流式加载时界面保持响应
- 切换对话时自动清除流式状态
- 消息更新时自动检测并停止流式状态

#### 10.4 流式加载流程

1. 用户发送消息或选择选项
2. 界面立即进入流式状态，显示呼吸指示器
3. 监听 `STREAM_TOKEN_RECEIVED` 事件，实时更新文本
4. 消息完成后，自动清除流式状态
5. 重新加载对话数据，显示完整消息

---

### 11. 转场效果

#### 11.1 黑屏转场

**显示效果：**

- 全屏黑屏显示
- 转场文字居中显示
- 动画淡入淡出效果

**交互控制：**

- 点击左半屏返回上一条
- 点击右半屏继续下一条
- 显示左右箭头指示交互区域

**自动播放：**

- 黑屏自动延长 2 秒显示时间
- 可通过设置调整

---

### 12. 播放控制

#### 12.1 自动播放

**开关控制：**

- 右上角设置中开启/关闭自动播放

**速度调整：**

- 范围：1-8秒/句
- 可自定义播放速度

**特殊处理：**

- 黑屏自动延长 2 秒
- 选项等待用户选择

#### 12.2 手动控制

**点击画面：**

- 点击画面任意位置继续下一句

**箭头按钮：**

- 左右箭头按钮导航
- 前进/后退切换对话

**全屏模式：**

- 手机全屏后自动旋转 90 度显示横屏
- 保持 16:9 比例

#### 12.3 重演功能

**功能说明：**

- 📖 按钮重新解析当前消息
- 刷新当前显示的对话内容
- 重新加载资源（背景、立绘、Live2D 动作和表情）
- 适用于资源更新后需要刷新显示的场景

**使用场景：**

- 世界书资源更新后，需要重新匹配资源
- 消息格式修改后，需要重新解析
- 资源加载失败后，需要重新尝试加载

---

## UI 布局

### 左上角

- 👤 **角色按钮**（点击展开菜单）
  - ✏️ **输入按钮**（折叠在角色按钮中）
  - 📊 **状态栏**（点击打开角色状态栏）

### 右上角

- ⚙️ **设置按钮**（点击展开菜单）
  - 🔲 **全屏按钮**（切换全屏模式）
  - 📖 **重演按钮**（重新解析当前消息）
  - 🕐 **历史按钮**（查看对话历史并快速跳转）

### 底部

- **对话框**（角色对话、旁白）
- **选项框**（选择分支）

### 中央

- **背景图片**
- **角色立绘**（Live2D 或静态图片）
- **CG 图片**（CG 模式时）
- **黑屏转场**（转场时）

---

### 13. 历史功能

#### 13.1 历史对话框

**打开方式：**

- 点击右上角设置按钮 → 历史按钮

**显示内容：**

- 显示所有历史消息
- 按时间倒序排列（最新的在前）
- 自动解析消息格式，显示为对话、旁白、黑屏、选项等类型

**快速跳转：**

- 点击历史消息可快速跳转到对应位置
- 自动重新加载对话数据
- 跳转后自动定位到对应对话

#### 13.2 历史消息解析

- 自动解析 `[[character||...]]`、`[[narration||...]]` 等格式
- 显示角色名、对话内容、旁白等
- 选项显示为用户发言格式
- 未解析的消息显示为原始文本

---

## 响应式设计

### 横屏显示

- **比例**：16:9 横屏显示
- **适配方式**：使用 `width` 和 `aspect-ratio` 实现，符合 iframe 适配要求
- **背景透明**：界面外背景透明，不填充颜色

### 屏幕适配

- **横屏**：正常显示，等比例缩放
- **竖屏**：等比例缩放，保持横屏比例
- **全屏**：手机全屏后自动旋转 90 度显示横屏

---

## 技术实现

### 前端技术栈

- **Vue 3**：Composition API
- **Tailwind CSS**：样式系统
- **PixiJS + pixi-live2d-display**：Live2D 渲染
- **TypeScript**：类型安全

### 性能优化

- `shallowRef` 用于大型数组（对话列表）
- localStorage 缓存样式设置
- 世界书资源缓存 5 秒
- 事件监听器自动清理
- 共享工具函数减少代码重复

### 数据流

1. **消息读取**：从酒馆读取消息 → `parseMessageBlocks` 解析
2. **资源匹配**：从世界书读取资源配置 → 根据文本匹配资源文件
3. **模型加载**：从角色卡变量读取 Live2D 配置
4. **事件监听**：监听酒馆事件实时更新
5. **用户交互**：裁剪/发送消息 → 触发 AI 生成

---

## 酒馆集成

### 使用的 API

- `getChatMessages()` - 获取聊天消息
- `createChatMessages()` - 创建消息
- `deleteChatMessages()` - 删除消息
- `setChatMessages()` - 更新消息
- `getCurrentMessageId()` - 获取当前消息 ID
- `getLastMessageId()` - 获取最后消息 ID
- `getVariables()` - 获取角色卡变量
- `getWorldbook()` - 获取世界书内容
- `triggerSlash('/trigger')` - 触发 AI 生成
- `eventOn()` - 监听酒馆事件

### 监听的事件

- `MESSAGE_RECEIVED` - 新消息到达
- `MESSAGE_UPDATED` - 消息更新
- `CHAT_CHANGED` - 聊天切换
- `STREAM_TOKEN_RECEIVED` - 流式 token

---

## 使用说明

### 基本使用

1. **准备世界书资源**：
   - 在酒馆中创建名为 `开场界面-模型数据` 的世界书
   - 添加模型、立绘、背景、CG 资源配置

2. **配置 Live2D 模型**（可选）：
   - 在角色卡变量中配置 `live2d_models` 数组
   - 或在世界书中配置模型资源

3. **开始对话**：
   - 在酒馆中打开角色卡
   - AI 使用新格式输出消息
   - 界面自动解析并显示演出效果

4. **自定义样式**：
   - 点击右上角齿轮图标
   - 在"形状"标签页开启"自定义模式"
   - 调整样式预设和颜色
   - 点击"保存应用"

### 消息格式示例

#### 新格式示例

**普通对话：**

```
[[character||角色名：程北极||场景：家中||动作：抱胸||表情：生气||台词：你怎么这样！]]
```

**CG 模式：**

```
[[character||角色名：程北极||CG场景：家中||台词：这是一张 CG 图片。]]
```

**旁白：**

```
[[narration||场景：教室||旁白：教室里阳光明媚，同学们正在认真听讲。]]
```

**黑屏转场：**

```
[[blacktext||黑屏文字：三小时后...]]
```

**用户消息：**

```
[[user||场景：教室||用户消息：我想去图书馆。]]
```

**选项（旧格式）：**

```
[[choice||选项1：去食堂||选项2：去图书馆||选项3：回宿舍]]
```

**选项（格式1，带角色回复）：**

```
[[choice||选项1：去食堂||角色名：程北极||台词：好的，我们一起去吧！]]
```

选择该选项后会显示角色回复，然后继续下一条对话，**不触发 AI 生成**。

**选项（格式2，纯选项列表）：**

```
[[choice||选项1：去食堂||选项2：去图书馆||选项3：回宿舍]]
```

选择该选项后会触发 AI 生成回复。

#### 世界书资源配置示例

**Live2D 模型资源：**

```json
{
  "type": "live2d_model",
  "modelName": "程北极",
  "files": {
    "model3": "https://example.com/models/character.model3.json",
    "textures": ["texture_00.png"]
  },
  "motions": [
    { "name": "待机", "file": "idle.motion3.json", "group": "idle" },
    { "name": "抱胸", "file": "cross_arms.motion3.json", "group": "gesture" }
  ],
  "expressions": [
    { "name": "生气", "file": "angry.exp3.json" }
  ],
  "textMappings": {
    "motion": {
      "idle.motion3.json": "待机",
      "cross_arms.motion3.json": "抱胸"
    },
    "expression": {
      "angry.exp3.json": "生气"
    }
  }
}
```

**背景资源：**

```json
{
  "type": "background",
  "backgrounds": [
    {
      "name": "家中",
      "file": "https://example.com/backgrounds/home.jpg",
      "textMappings": ["家中", "家里", "家"]
    },
    {
      "name": "教室",
      "file": "https://example.com/backgrounds/classroom.jpg",
      "textMappings": ["教室", "课堂"]
    }
  ]
}
```

### Live2D 模型配置（角色卡变量）

如果使用角色卡变量配置 Live2D 模型：

```json
{
  "live2d_models": [
    {
      "id": "character_01",
      "name": "程北极",
      "modelPath": "model.model3.json",
      "basePath": "https://example.com/models/",
      "version": 3,
      "motions": [
        { "group": "idle", "name": "待机", "file": "idle.motion3.json" }
      ],
      "expressions": ["happy", "sad", "angry"],
      "textures": ["texture_00.png"]
    }
  ]
}
```

---

## 测试模式

### 自动测试数据

当酒馆中没有消息时，界面会自动加载测试数据，方便演示和调试：

- 包含完整的对话流程示例
- 展示各种消息类型（角色对话、旁白、黑屏、选项）
- 展示 through 内心独白效果
- 展示场景切换

---

## Live2D 实现说明

### 动态加载方案

为了避免 pixi-live2d-display 与 pixi.js v8 的版本冲突，本项目采用**动态 CDN 加载**方案：

1. Live2D 依赖在运行时从 CDN 动态加载
2. 使用 pixi.js v6.5.10（与 pixi-live2d-display 兼容）
3. Cubism Core 自动从 CDN 加载
4. 不占用编译时打包体积

### 优势

- 无编译错误
- 按需加载，首屏更快
- Live2D 资源自动管理
- 完整的 Live2D 功能支持

---

## 注意事项

1. **消息格式**：AI 需要使用新格式输出，否则将使用默认解析
2. **世界书配置**：资源匹配功能需要正确配置世界书，资源存储在名为 `开场界面-模型数据` 的世界书中
3. **场景继承**：如果消息没有指定场景，会自动继承上一行的场景
4. **资源匹配**：匹配时只使用台词部分外的文本（角色名、场景、动作、表情），台词内容不参与匹配
5. **角色区分**：不同角色的相同文本会匹配到不同的资源文件，通过角色名区分
6. **Live2D 模型**：需要先配置模型才能使用 Live2D 功能，可在角色卡变量或世界书中配置
7. **MVU 集成**：角色状态栏需要 MVU 变量框架支持
8. **样式保存**：样式自动保存到 localStorage，清除浏览器数据会重置
9. **事件清理**：组件卸载时自动清理事件监听器，避免内存泄漏
10. **测试模式**：无消息时自动显示测试数据，方便调试
11. **iframe 适配**：界面使用 `width` 和 `aspect-ratio` 实现响应式，符合 iframe 适配要求
12. **资源缓存**：世界书资源会缓存 5 秒，每次演出开始前会重新读取确保使用最新配置

---

## 更新日志

### v2.0 - 新格式和世界书匹配

- ✨ 新增键值对格式的消息解析（新格式）
- ✨ 新增世界书资源自动匹配功能
- ✨ 新增场景继承功能
- ✨ 新增模糊匹配算法，支持特殊符号容错
- ✨ 新增资源缓存机制
- ✨ 新增历史功能（查看对话历史并快速跳转）
- ✨ 新增流式加载支持（实时显示 AI 生成内容）
- ✨ 新增选项新格式（支持角色回复）
- ✨ 新增重演功能（重新解析当前消息）
- ✨ 新增 IndexedDB 支持（Live2D 模型从本地存储加载）
- 🔄 保持向后兼容，仍支持旧格式

### v1.0 - 初始版本

- 基础对话系统
- Live2D 模型支持
- 对话框样式自定义
- 选项系统
- 角色状态栏
- 用户消息编辑
