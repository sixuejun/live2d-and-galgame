iv# PhonePanel 世界书格式说明

## 概述

PhonePanel 使用世界书来存储和读取聊天历史记录。每个联系人都对应一个独立的世界书条目。

## 条目名称格式

条目名称必须严格按照以下格式：

```
[与{联系人名称}的聊天记录]
```

**示例：**

- `[与神乐光的聊天记录]`
- `[与爱城华恋的聊天记录]`
- `[与星见纯那的聊天记录]`

## 消息格式

每条消息占一行，格式如下：

```
{发言者}：{消息内容}|{时间戳}
```

**格式说明：**

- `{发言者}`：发言者的名称（可以是角色名、用户名等）
- `：`：中文冒号（全角冒号）或英文冒号（半角冒号 `:`）都可以
- `{消息内容}`：消息的文本内容
- `|`：分隔符（竖线），用于分隔消息内容和时间戳
- `{时间戳}`：可选，消息的时间戳（格式：`YYYY-MM-DD HH:mm`）

**注意：**

- 时间戳是可选的，如果没有时间戳，可以省略 `|时间戳` 部分
- 如果发言者是用户（user），系统会自动识别并显示在右侧

## 完整示例

### 示例 1：基本格式

```
[与神乐光的聊天记录]

神乐光：你好，今天天气真不错
你：是啊，很适合出去走走
神乐光：要不要一起去公园？
你：好啊，什么时候？
神乐光：下午两点怎么样？
你：没问题，到时候见
```

### 示例 2：带时间戳的格式

```
[与爱城华恋的聊天记录]

爱城华恋：早上好！|2024-01-15 08:30
你：早上好，华恋|2024-01-15 08:32
爱城华恋：今天有什么安排吗？|2024-01-15 08:33
你：还没想好呢|2024-01-15 08:35
爱城华恋：要不要一起去看电影？|2024-01-15 08:36
```

### 示例 3：混合格式（部分有时间戳，部分没有）

```
[与星见纯那的聊天记录]

星见纯那：你好
你：你好，纯那
星见纯那：最近怎么样？|2024-01-15 10:00
你：还不错，你呢？|2024-01-15 10:02
星见纯那：我也很好
```

## 世界书条目配置

创建世界书条目时，需要设置以下属性：

- **名称（name）**：`[与{联系人名称}的聊天记录]`
- **内容（content）**：按照上述格式编写的消息列表
- **启用（enabled）**：`true`（必须启用）
- **关键词（keys）**：`[{联系人名称}]`（用于搜索匹配）
- **优先级（priority）**：`100`（建议值）

## 用户名称识别

系统会自动识别以下格式作为用户消息：

- 发言者名称等于角色卡中设置的 `user_name`
- 发言者名称包含 `user`、`玩家`、`你` 等关键词（不区分大小写）

用户消息会自动显示在聊天界面的右侧（气泡在右侧）。

## 连续发言处理

如果同一个人连续发送多条消息，系统会自动隐藏后续消息的发言者标签，只显示第一条消息的标签。

例如：

```
神乐光：第一条消息
神乐光：第二条消息（这条消息的发言者标签会被隐藏）
神乐光：第三条消息（这条消息的发言者标签会被隐藏）
```

## 注意事项

1. **条目名称必须精确匹配**：系统通过精确匹配条目名称来查找聊天记录，名称必须完全一致
2. **使用正确的冒号**：中文冒号（：）和英文冒号（:）都可以，但建议使用中文冒号以保持一致性
3. **时间戳格式**：时间戳格式为 `YYYY-MM-DD HH:mm`，例如 `2024-01-15 14:30`
4. **换行符**：每条消息必须单独占一行，使用换行符（`\n`）分隔
5. **空行处理**：空行会被自动忽略，不会影响消息解析
6. **特殊字符**：消息内容可以包含任何字符，包括表情符号、换行符等

## 在酒馆中创建世界书条目

1. 打开角色卡的世界书编辑界面
2. 点击"添加条目"或"新建条目"
3. 设置条目名称为：`[与{联系人名称}的聊天记录]`
4. 在内容区域输入聊天记录（按照上述格式）
5. 设置关键词为联系人名称
6. 确保条目已启用（enabled = true）
7. 设置优先级为 100（可选）
8. 保存条目

## 示例：完整的世界书条目配置

**条目名称：**

```
[与神乐光的聊天记录]
```

**内容：**

```
神乐光：早上好！今天天气真不错呢|2024-01-15 08:30
你：早上好，光！确实是个好天气|2024-01-15 08:32
神乐光：要不要一起去公园走走？|2024-01-15 08:33
你：好啊，什么时候？|2024-01-15 08:35
神乐光：下午两点怎么样？|2024-01-15 08:36
你：没问题，到时候见|2024-01-15 08:37
```

**关键词：**

```
神乐光
```

**其他设置：**

- 启用：✓（勾选）
- 优先级：100
